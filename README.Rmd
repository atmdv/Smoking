---
title: "Get more out of surveydata with multilevel modelling"
author: "Andreas Tyge Moller"
date: "25 okt 2018"
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Surveys on smoking habits can be analyzed more effectively
The smoking habits of Danish youth is frequently discussed these days, with
retailers and politicians competing to announce new measures and proposals for
curbing youth smoking.

Reliably measuring youth smoking frequencies is harder than you might expect 
though - see <http://altandetlige.dk/blog/6644/kommet-unge-dagligrygere-712>
(only available in Danish).

The official data on the smoking habits of the Danish population is collected
by every year by Danish Department of Health. A nationally representative sample
of 5,000 people are surveyed, and the National smoking frequency is measured by
the sample smoking frequency. That's it. No mension of uncertainty, no analysis.

But the data can be used much more efficiently. Just consider the 2016 survey.
The Danish Cancer Society collect data on smoking rates. Their survey samples
youth (aged 16-25) specifically, and 2,000 youth are surveyed. Youth are not 
equivalently grouped in the official data (but in the ages 15-19 and 20-29).
However, similar inferences could have been obtained from the official data, had 
you more efficiently exploited the information in the data.

This is where multilevel modelling comes in.

## What the smoking rates look like
Unfortunately the data behind the official smoking rates is unfortunately not
publicly available. The data are available annually after 1997, with a missing 
year in 2008. The smoking rates have experienced a consistent downward trend 
over the past 20 years.

```{r include=FALSE}
pacman::p_load(haven, dplyr, rstan, ggmcmc, rethinking, ggplot2)
# Load data
danskernes_rygevaner <- read_dta("C:/Users/Andreas Tyge Moller/Google Drive/Rygefrekvenser/DR_samlet.dta")
danskernes_rygevaner$smoker <- abs(danskernes_rygevaner$ryger_du - 2)
class(danskernes_rygevaner$smoker) <- "logical"
# Compute sample smoking prevalence
sample_smoking_prevalence <- danskernes_rygevaner %>%
  group_by(year) %>%
  summarise(sample_smoking_prevalence=mean(smoker, na.rm=T)*100)
```
```{r, echo=FALSE}
# Plot of sample smoking prevalence
ggplot(sample_smoking_prevalence, aes(year, sample_smoking_prevalence, group=1)) +
  geom_line(size=2, colour="#97d8f2") +
  theme_classic() +
  xlab("") + scale_x_discrete(breaks=seq(1998, 2016, 2)) +
  ylab("Sample smoking prevalence (percent)")
```

Data contain lots of variables, the majority of which are not fully consistent
over the years. Here I'll focus on the most central stratefication variables as
well as the main question "Do you smoke?". These variables have been
consistently collected since 2008, before which the survey setup was somewhat
different.

Since 2009 the smoking rate for young people (aged 16-29) has followed the 
overall smoking rate, but with larger deviations due to the smaller sample size 
(roughly 20 percent of the sample is below 30 years of age.).

```{r include=FALSE}
# Young smokers, ages 16-29
danskernes_rygevaner$young <- danskernes_rygevaner$alder7 %in% c(1, 2)
# After 2008 data are consistent until 2016
danskernes_rygevaner <- danskernes_rygevaner[which(danskernes_rygevaner$year>2008), ]
# Sample smoking prevalence, by young/not young. Age groups are only consistent after 2007.
sample_smoking_prevalence_grouped <- danskernes_rygevaner %>%
  group_by(year, young) %>%
  summarise(sample_smoking_prevalence=mean(smoker, na.rm=T)*100,
            group_size=n(),
            se=sqrt(var(smoker, na.rm = T)/n())*100)
# Plot of sample smoking prevalence, by young/not young. Age groups are only consistent after 2007.
```
```{r, echo=FALSE}
ggplot(data = sample_smoking_prevalence_grouped,
       aes(x = year, y = sample_smoking_prevalence, group = young, color = young)) +
  geom_line(size=2) +
  geom_errorbar(aes(ymin=sample_smoking_prevalence-se,
                    ymax=sample_smoking_prevalence+se, color=young), width=.1) +
  scale_color_manual(labels = c("Rest of sample", "Young people"),
                     values=c("#97d8f2", "#2a84a6")) +
  theme_classic() +
  theme(legend.position = c(0.9, 0.9)) +
  labs(color = "", x="", y="Sample smoking prevalence (percent)")  
```

I've added some error bars showing two standard deviations to get a feel for the
sample size. Looking at the two plots already gives cause for concern about
the reliability of the stratification of the survey sample. The
pattern of the overall smoking rate in 2014-2016 looks like it's driven by
noise. Comparing young people to the rest of the population, the changes
from year to year are implausibly large, and young people seem to have smoking 
rates inversely correlated with the rest of the sample. Not much can be learned
by looking at the changes from one year to the next. 

## Enter Bayesian data analysis
Stay tuned...










